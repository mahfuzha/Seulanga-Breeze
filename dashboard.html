<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Seulanga Breeze Dashboard</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #d9f3ff;
      text-align: center;
    }

    header {
      background-color: #0288d1;
      color: white;
      padding: 20px 0;
      font-size: 1.8rem;
      font-weight: bold;
    }

    main {
      margin-top: 40px;
    }

    .card {
      background: white;
      width: 300px;
      margin: auto;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }

    .card h2 {
      margin-bottom: 10px;
    }

    .status-pompa {
      width: 50px;
      height: 50px;
      margin: 15px auto;
      border-radius: 50%;
      background-color: #f44336;
      box-shadow: 0 0 20px rgba(244, 67, 54, 0.5);
      transition: background-color 0.3s;
    }

    .menu {
      display: flex;
      justify-content: center;
      margin-top: 40px;
      gap: 10px;
    }

    .menu button {
      background-color: #03a9f4;
      color: white;
      padding: 15px 25px;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .menu button:hover {
      background-color: #0288d1;
    }

    p {
      margin: 8px 0;
      font-size: 1rem;
    }

    .emoji {
      font-size: 1.3rem;
      vertical-align: middle;
    }
  </style>
</head>
<body>
  <header>
    <span class="emoji">üå§Ô∏è</span> Monitoring
  </header>

  <main>
    <div class="card">
      <h2><span class="emoji">üìä</span> Data Terkini</h2>
      <p><span class="emoji">üå°Ô∏è</span> Suhu: <span id="suhu">Menunggu...</span> ¬∞C</p>
      <p><span class="emoji">üíß</span> Kelembapan: <span id="kelembapan">Menunggu...</span> %</p>
      <div class="status-pompa" id="status-pompa"></div>
      <p>Status Pompa: <span id="status-pompa-text">Menunggu...</span></p>
      <p><span class="emoji">üìç</span> Pineung, Syiah Kuala, Banda Aceh, Aceh, Sumatra, 23122, Indonesia</p>
    </div>
  </main>

  <div class="menu">
    <button onclick="window.location.href='admin.html'"><span class="emoji">‚öôÔ∏è</span> Admin</button>
    <button onclick="window.location.href='akun.html'"><span class="emoji">üë§</span> Akun</button>
    <button onclick="window.location.href='riwayat.html'"><span class="emoji">üìä</span> Riwayat</button>
  </div>

  <!-- MQTT Client -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.1.0/mqttws31.min.js"></script>
  <script>
    const mqttHost = "test.mosquitto.org";
    const mqttPort = 8884; // port WSS yang lebih stabil
    const clientID = "webclient_" + Math.floor(Math.random() * 10000);
    const client = new Paho.MQTT.Client(mqttHost, mqttPort, clientID);

    // Reconnect timer
    let reconnectTimeout = 2000;

    function onConnect() {
      console.log("Terhubung ke MQTT broker");

      // Pasang handler pesan setelah connect
      client.onMessageArrived = onMessageArrived;

      // Subscribe ke topik
      client.subscribe("tekkom/iot/data", { qos: 0 });
      client.subscribe("tekkom/iot/pompa", { qos: 0 });
    }

    function onFailure(err) {
      console.error("Gagal koneksi:", err.errorMessage);
      setTimeout(connectMQTT, reconnectTimeout);
    }

    function onConnectionLost(responseObject) {
      if (responseObject.errorCode !== 0) {
        console.log("Koneksi MQTT terputus: " + responseObject.errorMessage);
        setTimeout(connectMQTT, reconnectTimeout);
      }
    }

    function onMessageArrived(message) {
      console.log("Pesan dari MQTT:", message.destinationName, message.payloadString);

      if (message.destinationName === "tekkom/iot/data") {
        try {
          const data = JSON.parse(message.payloadString);
          console.log("Data suhu/kelembapan:", data);

          if (data.suhu !== undefined && data.kelembapan !== undefined) {
            document.getElementById("suhu").textContent = parseFloat(data.suhu).toFixed(1);
            document.getElementById("kelembapan").textContent = parseFloat(data.kelembapan).toFixed(1);
          } else {
            console.warn("Format data tidak sesuai:", data);
          }
        } catch (err) {
          console.error("Error parsing data:", err);
        }
      }

      if (message.destinationName === "tekkom/iot/pompa") {
        const status = message.payloadString.trim();
        const statusElem = document.getElementById("status-pompa");
        const statusText = document.getElementById("status-pompa-text");

        if (status === "HIDUP") {
          statusElem.style.backgroundColor = "#4caf50";
          statusElem.style.boxShadow = "0 0 20px rgba(76,175,80,0.5)";
          statusText.textContent = "HIDUP";
        } else if (status === "MATI") {
          statusElem.style.backgroundColor = "#f44336";
          statusElem.style.boxShadow = "0 0 20px rgba(244,67,54,0.5)";
          statusText.textContent = "MATI";
        } else {
          console.warn("Status pompa tidak dikenal:", status);
        }
      }
    }

    function connectMQTT() {
      client.onConnectionLost = onConnectionLost;

      client.connect({
        onSuccess: onConnect,
        onFailure: onFailure,
        useSSL: true
      });
    }

    // Mulai koneksi MQTT saat halaman load
    connectMQTT();
  </script>
</body>
</html>
